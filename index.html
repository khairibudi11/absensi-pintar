<!DOCTYPE html>
<html lang="id">
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Sekolah Pintar</title>
    
    <link rel="icon" href="logo.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
      :root {
        --primary: #6366f1;
        --primary-glow: rgba(99, 102, 241, 0.4);
        --glass-bg: rgba(255, 255, 255, 0.85);
        --glass-border: rgba(255, 255, 255, 0.9);
        --text-dark: #1e293b;
        --text-grey: #64748b;
        --radius: 20px;
      }

      body {
        font-family: 'Plus Jakarta Sans', sans-serif;
        background: linear-gradient(135deg, #f5f3ff 0%, #eff6ff 100%);
        margin: 0; padding: 0;
        min-height: 100vh;
        color: var(--text-dark);
        display: flex; flex-direction: column;
        overflow-x: hidden; 
      }

      .blob {
        position: fixed; width: 300px; height: 300px;
        background: var(--primary); filter: blur(100px); opacity: 0.15;
        border-radius: 50%; z-index: -1; pointer-events: none;
      }
      .blob-1 { top: -100px; left: -100px; }
      .blob-2 { bottom: -100px; right: -100px; background: #ec4899; }

      .navbar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 16px 20px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 15px rgba(0,0,0,0.05);
        position: sticky; top: 0; z-index: 100;
      }
      .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 16px; }
      .brand-icon { width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: grid; place-items: center; }
      .jam-pill { background: #f1f5f9; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 13px; }

      .container {
        padding: 20px;
        display: flex; 
        flex-direction: column; 
        gap: 20px;
        width: 100%; 
        box-sizing: border-box;
        max-width: 1200px;
        margin: 0 auto;
      }

      .card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
      }
      
      .camera-box {
        position: relative;
        background: #000;
        border-radius: var(--radius);
        overflow: hidden;
        width: 100%;
        min-height: 300px; 
        display: flex; align-items: center; justify-content: center;
      }

      #reader { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
      #reader video { object-fit: cover !important; width: 100% !important; height: 100% !important; border-radius: var(--radius); }
      
      .cam-overlay {
        position: absolute; top:0; left:0; width:100%; height:100%;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: rgba(20, 20, 30, 0.85); z-index: 2; text-align: center; color: white;
      }
      .btn-cam {
        background: white; color: black; border: none; padding: 12px 24px;
        border-radius: 50px; font-weight: 700; cursor: pointer;
        display: flex; align-items: center; gap: 8px; margin-top: 15px;
        box-shadow: 0 4px 15px rgba(255,255,255,0.2);
      }
      .btn-cam.stop { background: #ef4444; color: white; position: absolute; bottom: 15px; z-index: 10; display: none; }

      .input-wrapper { position: relative; margin-top: 20px; }
      .input-fancy {
        width: 100%; padding: 14px 14px 14px 44px;
        border: 2px solid #e2e8f0; border-radius: 14px;
        font-size: 16px; font-weight: 600; outline: none; box-sizing: border-box;
      }
      .input-fancy:focus { border-color: var(--primary); }
      .input-fancy::placeholder { color: #94a3b8; font-weight: 500; opacity: 0.6; }
      .input-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-grey); font-size: 20px; }

      .switch-box { background: #f1f5f9; padding: 5px; border-radius: 14px; display: flex; margin-bottom: 20px; }
      .switch-btn {
        flex: 1; padding: 10px; border: none; background: transparent;
        border-radius: 10px; font-weight: 600; font-size: 14px; color: var(--text-grey);
        transition: 0.2s;
      }
      .switch-btn.active { background: white; color: var(--text-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

      .grid-absen { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .absen-btn {
        border: none; padding: 16px; border-radius: 16px;
        display: flex; flex-direction: column; align-items: center; gap: 6px;
        cursor: pointer; position: relative; transition: transform 0.1s;
      }
      .absen-btn:active { transform: scale(0.96); }
      .absen-btn h3 { margin: 0; font-size: 14px; font-weight: 800; }
      .absen-btn i { font-size: 24px; }
      
      .btn-hadir { background: #dcfce7; color: #166534; }
      .btn-sakit { background: #fef3c7; color: #b45309; }
      .btn-izin  { background: #dbeafe; color: #1e40af; }
      .btn-alpha { background: #fee2e2; color: #991b1b; }

      .btn-save {
        background: var(--text-dark); color: white; width: 100%;
        padding: 16px; border: none; border-radius: 14px;
        font-weight: 700; font-size: 16px; margin-top: 15px; cursor: pointer;
      }

      /* Desktop Layout */
      @media (min-width: 900px) {
        .container { 
          display: grid; grid-template-columns: 1fr 1.2fr; 
          align-items: start; gap: 30px; padding: 30px 20px;
        }
        .navbar { margin: 20px auto; border-radius: 100px; padding: 15px 30px; max-width: 1160px; top: 20px; }
        .camera-box { min-height: 400px; } 
        .grid-absen { gap: 20px; }
        .absen-btn { padding: 24px 16px; }
        .absen-btn i { font-size: 32px; }
      }
    </style>
  </head>
  <body>

    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <nav class="navbar">
      <div class="brand">
        <div class="brand-icon"><i class="ri-school-fill"></i></div>
        SDNRantauBujur
      </div>
      <div class="jam-pill" id="jam">--:--</div>
    </nav>

    <div class="container">
      
      <div class="card">
        <div style="text-align:center; font-weight:800; font-size:14px; color:var(--primary); margin-bottom:15px;">
          <i class="ri-qr-scan-2-line"></i> SCAN QR (Otomatis Hadir)
        </div>
        <div class="camera-box">
          <div id="reader" style="display:none;"></div>
          <div class="cam-overlay" id="camOverlay">
            <i class="ri-camera-lens-line" style="font-size:48px; opacity:0.5; margin-bottom:10px;"></i>
            <span style="font-size:14px; opacity:0.8;">Mode Standby</span>
            <button class="btn-cam" onclick="toggleCamera()" type="button">
              <i class="ri-play-fill"></i> Buka Kamera
            </button>
          </div>
          <button id="btnStop" class="btn-cam stop" onclick="toggleCamera()" type="button">
            <i class="ri-stop-circle-fill"></i> Matikan Kamera
          </button>
        </div>

        <div class="input-wrapper">
          <i class="ri-user-search-line input-icon"></i>
          <input type="text" id="idSiswa" class="input-fancy" placeholder="ID Siswa akan muncul di sini" readonly>
        </div>
      </div>

      <div class="card">
        <div class="switch-box">
          <button class="switch-btn active" onclick="gantiTab('absen')" id="btnTabAbsen">Presensi Harian</button>
          <button class="switch-btn" onclick="gantiTab('nilai')" id="btnTabNilai">Input Penilaian</button>
        </div>

        <div id="panelAbsen">
          
          <div style="background:#f8fafc; padding:15px; border-radius:14px; border:1px solid #e2e8f0; margin-bottom:20px;">
            <div style="text-align:center; font-size:11px; font-weight:800; color:#64748b; margin-bottom:10px;">
              PILIH MANUAL (UNTUK SISWA TIDAK HADIR)
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div>
                <select id="pilihKelasAbsen" class="input-fancy" onchange="updateDaftarSiswa('pilihKelasAbsen', 'pilihSiswaAbsen')" style="padding:10px; font-size:14px; padding-left:15px; cursor:pointer;">
                  <option value="" disabled selected hidden>Pilih Kelas...</option>
                  <option value="Kelas 1">Kelas 1</option>
                  <option value="Kelas 2">Kelas 2</option>
                  <option value="Kelas 3">Kelas 3</option>
                  <option value="Kelas 4">Kelas 4</option>
                  <option value="Kelas 5">Kelas 5</option>
                  <option value="Kelas 6">Kelas 6</option>
                </select>
              </div>
              <div>
                <select id="pilihSiswaAbsen" class="input-fancy" onchange="setManualAbsen()" style="padding:10px; font-size:14px; padding-left:15px; cursor:pointer;">
                  <option value="" disabled selected hidden>Pilih Siswa...</option>
                </select>
              </div>
            </div>
          </div>

          <div class="grid-absen">
            <button class="absen-btn btn-hadir" onclick="prosesAbsen('Hadir')">
              <i class="ri-checkbox-circle-fill"></i> <h3>HADIR</h3>
            </button>
            <button class="absen-btn btn-sakit" onclick="prosesAbsen('Sakit')">
              <i class="ri-hospital-fill"></i> <h3>SAKIT</h3>
            </button>
            <button class="absen-btn btn-izin" onclick="prosesAbsen('Izin')">
              <i class="ri-mail-send-fill"></i> <h3>IZIN</h3>
            </button>
            <button class="absen-btn btn-alpha" onclick="prosesAbsen('Alpha')">
              <i class="ri-close-circle-fill"></i> <h3>ALPHA</h3>
            </button>
          </div>
        </div>

        <div id="panelNilai" style="display:none;">
           <div style="display:flex; flex-direction:column; gap:15px;">
             
             <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
               <div>
                 <label style="font-size:12px; font-weight:700; color:var(--text-grey); margin-bottom:5px; display:block;">KELAS</label>
                 <select id="pilihKelasNilai" class="input-fancy" onchange="updateDaftarSiswa('pilihKelasNilai', 'pilihSiswaNilai')" style="padding:12px; padding-left:15px; cursor:pointer;">
                   <option value="" disabled selected hidden>Pilih Kelas...</option>
                   <option value="Kelas 1">Kelas 1</option>
                   <option value="Kelas 2">Kelas 2</option>
                   <option value="Kelas 3">Kelas 3</option>
                   <option value="Kelas 4">Kelas 4</option>
                   <option value="Kelas 5">Kelas 5</option>
                   <option value="Kelas 6">Kelas 6</option>
                 </select>
               </div>
               <div>
                 <label style="font-size:12px; font-weight:700; color:var(--text-grey); margin-bottom:5px; display:block;">NAMA SISWA</label>
                 <select id="pilihSiswaNilai" class="input-fancy" style="padding:12px; padding-left:15px; cursor:pointer;">
                   <option value="" disabled selected hidden>Pilih Siswa...</option>
                 </select>
               </div>
             </div>

             <div>
               <label style="font-size:12px; font-weight:700; color:var(--text-grey); margin-bottom:5px; display:block;">MATA PELAJARAN</label>
               <select id="mapel" class="input-fancy" style="padding:12px; padding-left:15px; cursor:pointer;">
                 <option value="" disabled selected hidden>Pilih Mata Pelajaran...</option>
                 <option value="PAIBP">PAIBP</option>
                 <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                 <option value="Matematika">Matematika</option>
                 <option value="IPAS">IPAS</option>
                 <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                 <option value="Penjaskes">Penjaskes</option>
                 <option value="Seni Rupa">Seni Rupa</option>
                 <option value="Pendidikan Bahasa Banjar">Pendidikan Bahasa Banjar</option>
                 <option value="Bahasa Inggris">Bahasa Inggris</option>
                 <option value="Pendidikan Al-Qur'an">Pendidikan Al-Qur'an</option>
                 <option value="PASS">PASS</option>
               </select>
             </div>

             <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
               <div>
                 <label style="font-size:12px; font-weight:700; color:var(--text-grey); margin-bottom:5px; display:block;">NILAI</label>
                 <input type="number" id="nilai" class="input-fancy" placeholder="0 - 100" style="padding:12px; padding-left:15px;">
               </div>
               <div>
                 <label style="font-size:12px; font-weight:700; color:var(--text-grey); margin-bottom:5px; display:block;">KETERANGAN</label>
                 <input type="text" id="ket" class="input-fancy" placeholder="Cth: Tuntas" style="padding:12px; padding-left:15px;">
               </div>
             </div>
             
             <button class="btn-save" onclick="prosesNilai()">
               <i class="ri-save-3-line"></i> Simpan Data Nilai
             </button>
           </div>
        </div>

      </div>
    </div>

    <script>
      setInterval(() => { document.getElementById('jam').innerText = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); }, 1000);

      let modeTab = 'absen'; 

      function gantiTab(tab) {
        modeTab = tab; 
        document.getElementById('btnTabAbsen').className = tab === 'absen' ? 'switch-btn active' : 'switch-btn';
        document.getElementById('btnTabNilai').className = tab === 'nilai' ? 'switch-btn active' : 'switch-btn';
        document.getElementById('panelAbsen').style.display = tab === 'absen' ? 'block' : 'none';
        document.getElementById('panelNilai').style.display = tab === 'nilai' ? 'block' : 'none';
        
        // Bersihkan ID Siswa saat pindah menu agar tidak bingung
        document.getElementById('idSiswa').value = '';
      }

      // ==============================================================
      // DATABASE SISWA (Isi dengan data siswa asli Anda)
      // ==============================================================
      const databaseSiswa = {
        "Kelas 1": [
          { id: "S001", nama: "Ahmad Taupik" },
          { id: "S002", nama: "Aida Erma" },
          { id: "S003", nama: "Aisyah" },
          { id: "S004", nama: "Aqila Azrina" },
          { id: "S005", nama: "Aqilla Farasya" },
          { id: "S006", nama: "Asyifa" },
          { id: "S007", nama: "Aura Azzahra" },
          { id: "S008", nama: "Muhammad Azka" },
          { id: "S009", nama: "Muhammad Azmi Ubaidillah" },
          { id: "S010", nama: "Muhammad Fadillah" },
          { id: "S011", nama: "Muhammad Hafiz Anshari" },
          { id: "S012", nama: "Muhammad Nizam Ilmi" },
          { id: "S013", nama: "Muhammad Rayhan Azizi" },
          { id: "S014", nama: "Muhammad Renaldi" },
          { id: "S015", nama: "Muhammad Rifan" },
          { id: "S016", nama: "Muhammad Rizki Maulana" },
          { id: "S017", nama: "Muhammad Syarifuddin" },
          { id: "S018", nama: "Muhammad Syauqan Bachsan" },
          { id: "S019", nama: "Muslimah" },
          { id: "S020", nama: "Nina" },
          { id: "S021", nama: "Nor Khalifah" },
          { id: "S022", nama: "Ramita Alfa" },
          { id: "S023", nama: "Riski Aulia" },
          { id: "S024", nama: "Risma Aulia" },
          { id: "S025", nama: "Saira Abidah" },
          { id: "S026", nama: "Syarifatun Nisa" },
          { id: "S027", nama: "Ziyadatul Hikmah" }
        ],
        "Kelas 2": [
          { id: "S028", nama: "Ahmad Zaki" },
          { id: "S029", nama: "Alwi Alfattah" },
          { id: "S030", nama: "Bilqis" },
          { id: "S031", nama: "Muspita Sari" },
          { id: "S032", nama: "Nadia" },
          { id: "S033", nama: "Nizam" },
          { id: "S034", nama: "Risma Lestari" },
          { id: "S035", nama: "Siti Aisah" },
          { id: "S036", nama: "Siti Aisyah" }
        ],
        "Kelas 3": [
          { id: "S037", nama: "Abdan Zaidan Al Gajali" },
          { id: "S038", nama: "Abdul Latif" },
          { id: "S039", nama: "Abdur Rauf" },
          { id: "S040", nama: "Aila Nor Aisya" },
          { id: "S041", nama: "Azkia Ramadhani" },
          { id: "S042", nama: "Hayatul" },
          { id: "S043", nama: "Hilmiyah" },
          { id: "S044", nama: "Ma'wa" },
          { id: "S045", nama: "Mahda" },
          { id: "S046", nama: "Mahfuzah" },
          { id: "S047", nama: "Maulana" },
          { id: "S048", nama: "Muhammad Aditiya" },
          { id: "S049", nama: "Muhammad Arung Al Malik" },
          { id: "S050", nama: "Muhammad Khalil Zayan" },
          { id: "S051", nama: "Muhammad Ma'mun" },
          { id: "S052", nama: "Muhammad Okta Rifai" },
          { id: "S053", nama: "Muhammad Wildan" },
          { id: "S054", nama: "Nor Alia" },
          { id: "S055", nama: "Rahmad" },
          { id: "S056", nama: "Siti Nafisah" },
          { id: "S057", nama: "Sri Mulyanti" }
        ],
        "Kelas 4": [
          { id: "S058", nama: "Ahmad Gazali" },
          { id: "S059", nama: "Ahmad Hakim" },
          { id: "S060", nama: "Ahmad Jaudi" },
          { id: "S061", nama: "Aldi Saputra" },
          { id: "S062", nama: "Alika Puteri" },
          { id: "S063", nama: "Khairunnisa" },
          { id: "S064", nama: "Khumairah" },
          { id: "S065", nama: "Listi Aulia" },
          { id: "S066", nama: "Maulida" },
          { id: "S067", nama: "Muhammad Aidil Adha" },
          { id: "S068", nama: "Muhammad Irsadi" },
          { id: "S069", nama: "Muhammad Kairul Azmi" },
          { id: "S070", nama: "Muhammad Sahriza" },
          { id: "S071", nama: "Muhammad Zainal Ilmi" },
          { id: "S072", nama: "Nadilah" },
          { id: "S073", nama: "Ranti" },
          { id: "S074", nama: "Rizqah" },
          { id: "S075", nama: "Sa'adah" },
          { id: "S076", nama: "Siti Zahra" },
          { id: "S077", nama: "Sri Hayatun Nisa" },
          { id: "S078", nama: "Syamsul Arifin" },
          { id: "S079", nama: "Zaifa" }
        ],
        "Kelas 5": [
          { id: "S080", nama: "Ahmad Gaidil Amin" },
          { id: "S081", nama: "Faudah" },
          { id: "S082", nama: "Hadijah" },
          { id: "S083", nama: "Hafiz Harizki" },
          { id: "S084", nama: "Junaid" },
          { id: "S085", nama: "Khairunnisa" },
          { id: "S086", nama: "Mahda" },
          { id: "S087", nama: "Mahfuz Amin" },
          { id: "S088", nama: "Mahfuz Hasan" },
          { id: "S089", nama: "Marpuah" },
          { id: "S090", nama: "Muhammad Akbar" },
          { id: "S091", nama: "Muhammad Bayan Akli" },
          { id: "S092", nama: "Muhammad Fajeri" },
          { id: "S093", nama: "Muhammad Kahfi" },
          { id: "S094", nama: "Muhammad Nabil" },
          { id: "S095", nama: "Muhammad Raihan" },
          { id: "S096", nama: "Muhammad Rifki Mukhratullah" },
          { id: "S097", nama: "Muhammad Saiban" },
          { id: "S098", nama: "Muhammad Zaini" },
          { id: "S099", nama: "Nor Syifa Zahra" },
          { id: "S100", nama: "Novaliya" }
        ],
        "Kelas 6": [
          { id: "S101", nama: "Abdurrahim" },
          { id: "S102", nama: "Ahmad Nor" },
          { id: "S103", nama: "Alfina Magfirah" },
          { id: "S104", nama: "Emel" },
          { id: "S105", nama: "Hafizatul Aulia" },
          { id: "S106", nama: "Hanifa Atiyah" },
          { id: "S107", nama: "Hasanati" },
          { id: "S108", nama: "Husna" },
          { id: "S109", nama: "Mahdiyatul Asyna" },
          { id: "S110", nama: "Muhammad Alfian" },
          { id: "S111", nama: "Muhammad Husien" },
          { id: "S112", nama: "Muhammad Iqbal" },
          { id: "S113", nama: "Muhammad Lutfi" },
          { id: "S114", nama: "Muhammad Nazril" },
          { id: "S115", nama: "Muhammad Ripa" },
          { id: "S116", nama: "Muhammad Zaki" },
          { id: "S117", nama: "Muzdalipah" },
          { id: "S118", nama: "Nadila" },
          { id: "S119", nama: "Nita" },
          { id: "S120", nama: "Nur Khadijah Abna" },
          { id: "S121", nama: "Syifa Hastari" }
        ]
      };

      // Memunculkan daftar nama sesuai kelas yang dipilih
      function updateDaftarSiswa(idDropdownKelas, idDropdownSiswa) {
        const kelasDipilih = document.getElementById(idDropdownKelas).value;
        const selectSiswa = document.getElementById(idDropdownSiswa);
        
        selectSiswa.innerHTML = '<option value="" disabled selected hidden>Pilih Siswa...</option>';

        if(databaseSiswa[kelasDipilih]) {
          databaseSiswa[kelasDipilih].forEach(siswa => {
            selectSiswa.innerHTML += `<option value="${siswa.id}">${siswa.nama}</option>`;
          });
        }
      }

      // Mengisi kolom ID Kiri saat guru memilih nama secara manual
      function setManualAbsen() {
        const idTerpilih = document.getElementById('pilihSiswaAbsen').value;
        if(idTerpilih) {
          document.getElementById('idSiswa').value = idTerpilih;
        }
      }

      let scanner = null;
      let isCamOn = false;

      function toggleCamera() {
        const btnStop = document.getElementById('btnStop');
        const overlay = document.getElementById('camOverlay');
        const reader = document.getElementById('reader');

        if (!isCamOn) {
          reader.style.display = 'block';
          overlay.style.display = 'none';
          btnStop.style.display = 'flex';
          
          scanner = new Html5Qrcode("reader");
          scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
            (decoded) => {
              new Audio('https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/beep.mp3').play();
              
              // Masukkan ID hasil scan ke input kiri
              document.getElementById('idSiswa').value = decoded;
              toggleCamera(); 
              
              if (modeTab === 'absen') {
                // Eksekusi absen otomatis Hadir jika di tab presensi
                prosesAbsen('Hadir'); 
              } else {
                Swal.fire('Informasi', 'Anda sedang di menu Penilaian. Silakan pilih Kelas dan Nama Siswa dari daftar di kotak sebelah kanan.', 'info');
              }
            })
            .catch(err => { 
              Swal.fire('Error', 'Izin kamera diperlukan atau kamera tidak tersedia', 'error'); 
              toggleCamera(); 
            });
          
          isCamOn = true;
        } else {
          if(scanner) scanner.stop().then(() => scanner.clear());
          reader.style.display = 'none';
          overlay.style.display = 'flex';
          btnStop.style.display = 'none';
          isCamOn = false;
        }
      }

      function prosesAbsen(status) {
        kirimData('absen', status);
      }
      function prosesNilai() {
        kirimData('nilai');
      }

      function kirimData(tipe, statusAbsen = '') {
        const URL_GOOGLE_SCRIPT = "https://script.google.com/macros/s/AKfycbyZVyv5Kppy2Iu-mRbjzYoaLiGzuVVu5qtkOqHAhXx_qpZEItyHRBam6-cKsbdXcgq0/exec";
        let payload = {};

        if(tipe === 'absen') {
           // Selalu ambil ID dari KOTAK KIRI (bisa terisi karena SCAN, atau karena KLIK MANUAL)
           const id = document.getElementById('idSiswa').value;
           if(!id) return Swal.fire('Data Kosong', 'Silakan Scan QR atau pilih nama siswa secara manual!', 'warning');
           payload = { tipe: 'absen', id: id, status: statusAbsen };
        } else {
           // Nilai mengambil ID dari Dropdown Siswa Nilai
           const idSiswaDipilih = document.getElementById('pilihSiswaNilai').value;
           if(!idSiswaDipilih) return Swal.fire('Data Tidak Lengkap', 'Silakan pilih Kelas dan Nama Siswa terlebih dahulu!', 'warning');

           const mp = document.getElementById('mapel').value;
           const nl = document.getElementById('nilai').value;
           const kt = document.getElementById('ket').value || '-';
           
           if(!mp || !nl) return Swal.fire('Lengkapi Data', 'Mata Pelajaran dan Nilai wajib diisi', 'warning');
           
           payload = { tipe: 'nilai', id: idSiswaDipilih, mapel: mp, ket: kt, nilai: nl };
        }

        Swal.fire({title: 'Menyimpan Data...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
        
        fetch(URL_GOOGLE_SCRIPT, {
          method: 'POST',
          body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(res => {
          Swal.close();
          if(res.status === 'success') {
             Swal.fire({icon: 'success', title: 'Berhasil!', text: res.pesan || 'Data telah tersimpan', timer: 1500, showConfirmButton: false});
             
             // Bersihkan form setelah sukses
             if(tipe === 'nilai') {
               document.getElementById('nilai').value = ''; 
               document.getElementById('ket').value = '';
             } else {
               document.getElementById('idSiswa').value = '';
               // Kembalikan pilihan dropdown manual ke awal
               document.getElementById('pilihKelasAbsen').selectedIndex = 0;
               document.getElementById('pilihSiswaAbsen').innerHTML = '<option value="" disabled selected hidden>Pilih Siswa...</option>';
             }
          } else {
             Swal.fire('Gagal', res.pesan, 'error');
          }
        })
        .catch(err => { 
          Swal.close();
          Swal.fire('Error', 'Gagal terhubung ke Google Spreadsheet. Periksa koneksi internet Anda.', 'error'); 
        });
      }
    </script>
  </body>
</html>
